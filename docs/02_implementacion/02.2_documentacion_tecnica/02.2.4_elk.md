# Guia d'Instal·lació i Configuració de la Suite ELK a AWS  
Elastic i Kibana

Establir la connexió amb la màquina i crear l'usuari personal, assignant com a contrasenya “adrian”.

Crear l'usuari anomenat “elastic” i afegir-lo al grup “sudoers” per tal que disposi de privilegis d'administrador.

## Instal·lació servei  
Crear el directori d’elastic (/elastic)

Instal·lem elastic i kibana

Descomprimim els fitxers “tar”

## Configuració serveis

Canviem els permisos del directori elastic

Executem el servei d’Elastic


Configurem Kibana

Execució del kibana-setup

Configurem elasticsearch

Un cop completada tota la configuració, accedim a Elastic a través del navegador web utilitzant l’adreça IP pública assignada per AWS.

## Auditbeat  
Instal·lació al host

Configuració Auditbeat de Elastic i Kibana

Carregar assets

Iniciar Auditbeat

Afegir l’Auditbeat a Elastic

Visualització de la informació

Fer que els serveis d’Elastic, Kibana i Auditbeat arrenquin amb el sistema  
Creem el servei d’Elastic

Servei Kibana

Servei Auditbeat (usuari root perquè auditbeat s’ha d’executar amb sudo)

## Configuració a hosts  
Configuració general a cada host:

### Sergio:

### Sharam:

### Adrià:

---

## Script per Auditbeat

````bash
#!/bin/bash

# Pedir datos al usuario
read -p "Introduce el nombre de usuario SSH (ej. ubuntu): " SSH_USER
read -p "Introduce la IP pública del cliente: " CLIENT_IP
read -p "Introduce la ruta a la clave .pem: " KEY_PATH

# Variables de versión
AUDITBEAT_VERSION="8.17.4"
AUDITBEAT_DIR="auditbeat-${AUDITBEAT_VERSION}-linux-x86_64"
AUDITBEAT_TAR="${AUDITBEAT_DIR}.tar.gz"

# Configuración auditbeat.yml
CONFIG_B64="CmF1ZGl0YmVhdC5tb2R1bGVzOgoKLSBtb2R1bGU6IGF1ZGl0ZAogICMgTG9hZCBhdWRpdCBydWxlcyBmcm9tIHNlcGFyYXRlIGZpbGVzLiBTYW1lIGZvcm1hdCBhcyBhdWRpdC5ydWxlcyg3KS4KICBhdWRpdF9ydWxlX2ZpbGVzOiBbJyR7cGF0aC5jb25maWd9L2F1ZGl0LnJ1bGVzLmQvKi5jb25mJ10KICBhdWRpdF9ydWxlczogfAoKLSBtb2R1bGU6IGZpbGVfaW50ZWdyaXR5CiAgcGF0aHM6CiAgICAtIC9iaW4KICAgIC0gL3Vzci9iaW4KICAgIC0gL3NiaW4KICAgIC0gL3Vzci9zYmluCiAgICAtIC9ldGMKCi0gbW9kdWxlOiBzeXN0ZW0KICBkYXRhc2V0czoKICAgIC0gcGFja2FnZSAgIyBJbnN0YWxsZWQsIHVwZGF0ZWQsIGFuZCByZW1vdmVkIHBhY2thZ2VzCiAgcGVyaW9kOiAybSAgIyBUaGUgZnJlcXVlbmN5IGF0IHdoaWNoIHRoZSBkYXRhc2V0cyBjaGVjayBmb3IgY2hhbmdlcwoKLSBtb2R1bGU6IHN5c3RlbQogIGRhdGFzZXRzOgogICAgLSBob3N0ICAgICMgR2VuZXJhbCBob3N0IGluZm9ybWF0aW9uLCBlLmcuIHVwdGltZSwgSVBzCiAgICAtIGxvZ2luICAgIyBVc2VyIGxvZ2lucywgbG9nb3V0cywgYW5kIHN5c3RlbSBib290cy4KICAgIC0gcHJvY2VzcyAjIFN0YXJ0ZWQgYW5kIHN0b3BwZWQgcHJvY2Vzc2VzCiAgICAtIHNvY2tldCAgIyBPcGVuZWQgYW5kIGNsb3NlZCBzb2NrZXRzCiAgICAtIHVzZXIgICAgIyBVc2VyIGluZm9ybWF0aW9uCiAgc3RhdGUucGVyaW9kOiAxMmgKICB1c2VyLmRldGVjdF9wYXNzd29yZF9jaGFuZ2VzOiB0cnVlCiAgbG9naW4ud210cF9maWxlX3BhdHRlcm46IC92YXIvbG9nL3d0bXoKICBsb2dpbi5idG1wX2ZpbGVfcGF0dGVybjogL3Zhci9sb2cvYnRtcCoKCnNldHVwLnRlbXBsYXRlLnNldHRpbmdzOgogIGluZGV4Lm51bWJlcl9vZl9zaGFyZHM6IDEKCnNldHVwLmRhc2hib2FyZHMuZW5hYmxlZDogdHJ1ZQoKc2V0dXAua2liYW5hOgogIGhvc3Q6ICJodHRwOi8vMTAuMi4xLjc2OjU2MDEiCiAgdXNlcm5hbWU6ICJlbGFzdGljIgogIHBhc3N3b3JkOiAiU3VhaEF3bWo5RkxFM3ZsaWJ0eCIKCm91dHB1dC5lbGFzdGljc2VhcmNoOgogIGhvc3RzOiBbImh0dHA6Ly8xMC4yLjEuNzY6OTIwMCJdCiAgdXNlcm5hbWU6ICJlbGFzdGljIgogIHBhc3N3b3JkOiAiU3VhaEF3bWo5RkxFM3ZsaWJ0eCIKICBzc2wudmVyaWZpY2F0aW9uX21vZGU6ICJub25lIgogIHByZXNldDogYmFsYW5jZWQKCnByb2Nlc3NvcnM6CiAgLSBhZGRfaG9zdF9tZXRhZGF0YTogfgogIC0gYWRkX2Nsb3VkX21ldGFkYXRhOiB+CiAgLSBhZGRfZG9ja2VyX21ldGFkYXRhOiB+"

# Configuración del servicio systemd
SERVICE_B64="W1VuaXRdCkRlc2NyaXB0aW9uPUF1ZGl0YmVhdApBZnRlcj1uZXR3b3JrLW9ubGluZS50YXJnZXQKCltTZXJ2aWNlXQpFeGVjU3RhcnQ9L2VsYXN0aWMvYXVkaXRiZWF0LTguMTcuNC1saW51eC14ODZfNjQvYXVkaXRiZWF0IC1lClVzZXI9cm9vdApHcm91cD1yb290CldvcmtpbmdEaXJlY3Rvcnk9L2VsYXN0aWMvYXVkaXRiZWF0LTguMTcuNC1saW51eC14ODZfNjQKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldA=="

# Comando remoto
ssh -i "$KEY_PATH" ${SSH_USER}@${CLIENT_IP} bash <<EOF
  set -e

  echo "[*] Creando usuario elastic..."
  sudo useradd elastic -m -s /bin/bash || true
  echo "elastic:elastic" | sudo chpasswd
  sudo usermod -aG sudo elastic

  echo "[*] Preparando directorio y descargando Auditbeat..."
  sudo mkdir -p /elastic
  cd /elastic
  sudo wget https://artifacts.elastic.co/downloads/beats/auditbeat/${AUDITBEAT_TAR}
  sudo tar -xzf ${AUDITBEAT_TAR}

  echo "[*] Aplicando configuración..."
  echo "\$(echo ${CONFIG_B64} | base64 -d)" | sudo tee /elastic/${AUDITBEAT_DIR}/auditbeat.yml > /dev/null
  sudo chown root:root /elastic/${AUDITBEAT_DIR}/auditbeat.yml

  echo "[*] Ejecutando setup de Auditbeat..."
  cd /elastic/${AUDITBEAT_DIR}
  sudo ./auditbeat setup --dashboards -e || true

  echo "[*] Creando servicio systemd..."
  echo "\$(echo ${SERVICE_B64} | base64 -d)" | sudo tee /etc/systemd/system/auditbeat.service > /dev/null

  echo "[*] Habilitando y arrancando el servicio..."
  sudo systemctl daemon-reload
  sudo systemctl enable auditbeat.service
  sudo systemctl start auditbeat.service

  echo "[✔] Auditbeat instalado y en funcionamiento."
EOF
