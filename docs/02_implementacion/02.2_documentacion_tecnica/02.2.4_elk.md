# Guía de Instalación y Configuración del ELK Stack en AWS  
**Elastic, Kibana y Auditbeat**

---

## 1. Conexión Inicial y Gestión de Usuarios

Establece conexión con la máquina.
Crea un usuario personal con la contraseña: adrian.  
  ![Captura 1](cap_ELK/1.png)

Crea el usuario elastic y añádelo al grupo sudo para otorgarle privilegios de administrador.  
  ![Captura 2](cap_ELK/2.png)

---

## 2. Instalación del ELK Stack

### 2.1 Preparación del Entorno

Crea el directorio principal de Elastic: /elastic  
  ![Captura 3](cap_ELK/3.png)

### 2.2 Descarga e Instalación

Instala Elastic y Kibana.  
  ![Captura 4](cap_ELK/4.png)  
  ![Captura 4.1](cap_ELK/4.1.png)

Descomprime los archivos .tar.  
  ![Captura 5](cap_ELK/5.png)

---

## 3. Configuración de Servicios

### 3.1 Elasticsearch

Cambia los permisos del directorio /elastic.  
  ![Captura 6](cap_ELK/6.png)

Ejecuta el servicio de Elasticsearch.  
  ![Captura 7](cap_ELK/7.png)  
  ![Captura 7.1](cap_ELK/7.1.png)

### 3.2 Kibana

Realiza la configuración inicial de Kibana.  
  ![Captura 8](cap_ELK/8.png)

Ejecuta el kibana-setup.  
  ![Captura 9](cap_ELK/9.png)

Realiza los ajustes finales en la configuración de Elasticsearch.  
  ![Captura 10](cap_ELK/10.png)

Accede a Elastic desde el navegador utilizando la IP pública de AWS.  
  ![Captura 11](cap_ELK/11.png)

---

## 4. Integración de Auditbeat

### 4.1 Instalación

Instala Auditbeat en el host.  
  ![Captura 12](cap_ELK/12.png)

### 4.2 Configuración

Configura Auditbeat para integrarse con Elastic y Kibana.  
  ![Captura 13](cap_ELK/13.png)  
  ![Captura 13.1](cap_ELK/13.1.png)

Carga los assets necesarios.  
  ![Captura 14](cap_ELK/14.png)

Inicia el servicio de Auditbeat.  
  ![Captura 15](cap_ELK/15.png)

Añade Auditbeat al stack de Elastic.  
  ![Captura 16](cap_ELK/16.png)

Verifica la visualización de los datos.  
  ![Captura 17](cap_ELK/17.png)

---

## 5. Configuración de Servicios al Inicio del Sistema

### 5.1 Elasticsearch

Crea el servicio de systemd para Elasticsearch.  
  ![Captura 18](cap_ELK/18.png)  
  ![Captura 18.1](cap_ELK/18.1.png)  
  ![Captura 18.2](cap_ELK/18.2.png)

### 5.2 Kibana

Crea el servicio para Kibana.  
  ![Captura 19](cap_ELK/19.png)  
  ![Captura 19.1](cap_ELK/19.1.png)

### 5.3 Auditbeat

Crea el servicio para Auditbeat (requiere privilegios de root).  
  ![Captura 20](cap_ELK/20.png)  
  ![Captura 20.1](cap_ELK/20.1.png)

---

## 6. Configuración por Hosts

### Configuración General para Cada Host  
  ![Captura 21](cap_ELK/21.png)  
  ![Captura 21.1](cap_ELK/21.1.png)

### Host: Sergio  
  ![Captura 22](cap_ELK/22.png)

### Host: Sharam  
  ![Captura 23](cap_ELK/23.png)

### Host: Adrià  
  ![Captura 24](cap_ELK/24.png)

---

## Script para Auditbeat

````bash

#!/bin/bash

# Pedir datos al usuario
read -p "Introduce el nombre de usuario SSH (ej. ubuntu): " SSH_USER
read -p "Introduce la IP pública del cliente: " CLIENT_IP
read -p "Introduce la ruta a la clave .pem: " KEY_PATH

# Variables de versión
AUDITBEAT_VERSION="8.17.4"
AUDITBEAT_DIR="auditbeat-${AUDITBEAT_VERSION}-linux-x86_64"
AUDITBEAT_TAR="${AUDITBEAT_DIR}.tar.gz"

# Configuración auditbeat.yml
CONFIG_B64="..."

# Configuración del servicio systemd
SERVICE_B64="..."

# Comando remoto
ssh -i "$KEY_PATH" ${SSH_USER}@${CLIENT_IP} bash <<EOF
  set -e

  echo "[*] Creando usuario elastic..."
  sudo useradd elastic -m -s /bin/bash || true
  echo "elastic:elastic" | sudo chpasswd
  sudo usermod -aG sudo elastic

  echo "[*] Preparando directorio y descargando Auditbeat..."
  sudo mkdir -p /elastic
  cd /elastic
  sudo wget https://artifacts.elastic.co/downloads/beats/auditbeat/${AUDITBEAT_TAR}
  sudo tar -xzf ${AUDITBEAT_TAR}

  echo "[*] Aplicando configuración..."
  echo "\$(echo ${CONFIG_B64} | base64 -d)" | sudo tee /elastic/${AUDITBEAT_DIR}/auditbeat.yml > /dev/null
  sudo chown root:root /elastic/${AUDITBEAT_DIR}/auditbeat.yml

  echo "[*] Ejecutando setup de Auditbeat..."
  cd /elastic/${AUDITBEAT_DIR}
  sudo ./auditbeat setup --dashboards -e || true

  echo "[*] Creando servicio systemd..."
  echo "\$(echo ${SERVICE_B64} | base64 -d)" | sudo tee /etc/systemd/system/auditbeat.service > /dev/null

  echo "[*] Habilitando y arrancando el servicio..."
  sudo systemctl daemon-reload
  sudo systemctl enable auditbeat.service
  sudo systemctl start auditbeat.service

  echo "[✔] Auditbeat instalado y en funcionamiento."
EOF
