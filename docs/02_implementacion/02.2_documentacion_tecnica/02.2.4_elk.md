# Guía de Instalación y Configuración del ELK Stack en AWS  
Elastic y Kibana

Establecer la conexión con la máquina y crear el usuario personal, asignando como contraseña “adrian”.  
![1 captura](cap_ELK/1.png)

Crear el usuario llamado “elastic” y añadirlo al grupo “sudoers” para que disponga de privilegios de administrador.  
![2 captura](cap_ELK/2.png)

## Instalación del servicio  
Crear el directorio de elastic (/elastic)  
![3 captura](cap_ELK/3.png)

Instalamos elastic y kibana  
![4 captura](cap_ELK/4.png)  
![5 captura](cap_ELK/4.1.png)

Descomprimimos los ficheros “tar”  
![5 captura](cap_ELK/5.png)

## Configuración de los servicios

Cambiamos los permisos del directorio elastic  
![6 captura](cap_ELK/6.png)

Ejecutamos el servicio de Elastic  
![7 captura](cap_ELK/7.png)  
![7.1aptura](cap_ELK/7.1.png)

Configuramos Kibana  
![8 captura](cap_ELK/8.png)

Ejecución del kibana-setup  
![9 captura](cap_ELK/9.png)

Configuramos elasticsearch  
![10 captura](cap_ELK/10.png)

Una vez completada toda la configuración, accedemos a Elastic a través del navegador web utilizando la dirección IP pública asignada por AWS.  
![11 captura](cap_ELK/11.png)

## Auditbeat  
Instalación en el host  
![12 captura](cap_ELK/12.png)

Configuración de Auditbeat con Elastic y Kibana  
![13 captura](cap_ELK/13.png)  
![13.1 captura](cap_ELK/13.1.png)

Cargar assets  
![14 captura](cap_ELK/14.png)

Iniciar Auditbeat  
![15 captura](cap_ELK/15.png)

Añadir Auditbeat a Elastic  
![16 captura](cap_ELK/16.png)

Visualización de la información  
![17 captura](cap_ELK/17.png)

Hacer que los servicios de Elastic, Kibana y Auditbeat se inicien con el sistema  
Creamos el servicio de Elastic  
![18 captura](cap_ELK/18.png)  
![18.1 captura](cap_ELK/18.1.png)  
![18.2 captura](cap_ELK/18.2.png)

Servicio de Kibana  
![19 captura](cap_ELK/19.png)  
![19.1 captura](cap_ELK/19.1.png)

Servicio de Auditbeat (usuario root porque Auditbeat debe ejecutarse con sudo)  
![20 captura](cap_ELK/20.png)  
![20.1 captura](cap_ELK/20.1.png)

## Configuración en hosts  
Configuración general en cada host:  
![21 captura](cap_ELK/21.png)  
![21.1 captura](cap_ELK/21.1.png)

### Sergio:  
![22 captura](cap_ELK/22.png)

### Sharam:  
![23 captura](cap_ELK/23.png)

### Adrià:  
![24 captura](cap_ELK/24.png)

---

## Script para Auditbeat

````bash
#!/bin/bash

# Pedir datos al usuario
read -p "Introduce el nombre de usuario SSH (ej. ubuntu): " SSH_USER
read -p "Introduce la IP pública del cliente: " CLIENT_IP
read -p "Introduce la ruta a la clave .pem: " KEY_PATH

# Variables de versión
AUDITBEAT_VERSION="8.17.4"
AUDITBEAT_DIR="auditbeat-${AUDITBEAT_VERSION}-linux-x86_64"
AUDITBEAT_TAR="${AUDITBEAT_DIR}.tar.gz"

# Configuración auditbeat.yml
CONFIG_B64="..."

# Configuración del servicio systemd
SERVICE_B64="..."

# Comando remoto
ssh -i "$KEY_PATH" ${SSH_USER}@${CLIENT_IP} bash <<EOF
  set -e

  echo "[*] Creando usuario elastic..."
  sudo useradd elastic -m -s /bin/bash || true
  echo "elastic:elastic" | sudo chpasswd
  sudo usermod -aG sudo elastic

  echo "[*] Preparando directorio y descargando Auditbeat..."
  sudo mkdir -p /elastic
  cd /elastic
  sudo wget https://artifacts.elastic.co/downloads/beats/auditbeat/${AUDITBEAT_TAR}
  sudo tar -xzf ${AUDITBEAT_TAR}

  echo "[*] Aplicando configuración..."
  echo "\$(echo ${CONFIG_B64} | base64 -d)" | sudo tee /elastic/${AUDITBEAT_DIR}/auditbeat.yml > /dev/null
  sudo chown root:root /elastic/${AUDITBEAT_DIR}/auditbeat.yml

  echo "[*] Ejecutando setup de Auditbeat..."
  cd /elastic/${AUDITBEAT_DIR}
  sudo ./auditbeat setup --dashboards -e || true

  echo "[*] Creando servicio systemd..."
  echo "\$(echo ${SERVICE_B64} | base64 -d)" | sudo tee /etc/systemd/system/auditbeat.service > /dev/null

  echo "[*] Habilitando y arrancando el servicio..."
  sudo systemctl daemon-reload
  sudo systemctl enable auditbeat.service
  sudo systemctl start auditbeat.service

  echo "[✔] Auditbeat instalado y en funcionamiento."
EOF
